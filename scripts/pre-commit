#!/bin/bash
# Pre-commit hook: Run LLM evaluation before allowing commit
# Install with: npm run install-hooks

set -e

echo ""
echo "ðŸ¤– Running LLM quality checks..."
echo ""

# Check if .env exists
if [ ! -f .env ]; then
  echo "âš ï¸  Warning: .env file not found"
  echo "   Skipping LLM evaluation (set ANTHROPIC_API_KEY to enable)"
  exit 0
fi

# Check if API key is set
source .env 2>/dev/null || true

if [ -z "$ANTHROPIC_API_KEY" ]; then
  echo "âš ï¸  Warning: ANTHROPIC_API_KEY not set in .env"
  echo "   Skipping LLM evaluation"
  exit 0
fi

# Check if we should skip (for emergency commits)
if [ "$SKIP_LLM_CHECK" = "1" ]; then
  echo "â­ï¸  Skipping LLM evaluation (SKIP_LLM_CHECK=1)"
  exit 0
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if there are any relevant files to evaluate
RELEVANT_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|ts|jsx|tsx|py|go|java|rs)$' || true)

if [ -z "$RELEVANT_FILES" ]; then
  echo "âœ… No code files changed - skipping evaluation"
  exit 0
fi

echo "ðŸ“ Files to evaluate:"
echo "$RELEVANT_FILES" | sed 's/^/   - /'
echo ""

# Run evaluation
echo "â³ Running evaluation (this may take 10-30 seconds)..."
npm run eval --silent

# Check results
if [ -f test-results.json ]; then
  # Use Node.js to check pass rate
  PASS_RATE=$(node -e "
    const fs = require('fs');
    const results = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
    const total = results.results?.length || 0;
    const passed = results.results?.filter(r => r.success).length || 0;
    const passRate = total > 0 ? (passed / total) * 100 : 0;
    console.log(passRate.toFixed(1));
  ")

  echo ""
  echo "ðŸ“Š Pass Rate: ${PASS_RATE}%"

  # Check against threshold (default 70%)
  THRESHOLD=${LLM_QUALITY_THRESHOLD:-70}

  if (( $(echo "$PASS_RATE < $THRESHOLD" | bc -l) )); then
    echo ""
    echo "âŒ Quality check FAILED"
    echo "   Pass rate (${PASS_RATE}%) is below threshold (${THRESHOLD}%)"
    echo ""
    echo "   Options:"
    echo "   1. Fix the issues and commit again"
    echo "   2. Skip check (emergency): SKIP_LLM_CHECK=1 git commit"
    echo "   3. View details: npm run view"
    echo ""
    exit 1
  else
    echo "âœ… Quality check PASSED"
    echo ""
  fi
else
  echo "âš ï¸  No results file generated - evaluation may have failed"
  echo "   Proceeding with commit (check logs)"
fi

exit 0
